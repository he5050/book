---
title: å¾®ä¿¡å°ç¨‹åº VisionKit èº«ä»½è¯è¯†åˆ«ä¸è£å‰ª
date: 2025-10-27 15:30:00
permalink: /note/wechat-miniprogram-visionkit-idcard
description: ä»‹ç»å¦‚ä½•åœ¨å¾®ä¿¡å°ç¨‹åºä¸­ä½¿ç”¨ VisionKit å®ç°èº«ä»½è¯è‡ªåŠ¨è¯†åˆ«ã€è‡ªåŠ¨è£å‰ªå¹¶è¿”å›æ ‡å‡†åŒ–å›¾ç‰‡
categories:
  - å…¶ä»–
tags:
  - å¾®ä¿¡å°ç¨‹åº
  - VisionKit
  - èº«ä»½è¯è¯†åˆ«
  - å›¾åƒå¤„ç†
---

# å¾®ä¿¡å°ç¨‹åº VisionKit èº«ä»½è¯è¯†åˆ«ä¸è£å‰ª

## ç®€ä»‹

åœ¨å°ç¨‹åºçš„å®åè®¤è¯åœºæ™¯ä¸­ï¼Œæˆ‘ä»¬å¸¸å¸¸éœ€è¦ç”¨æˆ·ä¸Šä¼ èº«ä»½è¯ç…§ç‰‡ã€‚ä½†å…‰é ä¸Šä¼ è¿˜ä¸å¤Ÿï¼Œæˆ‘ä»¬å¸Œæœ›è‡ªåŠ¨æ£€æµ‹èº«ä»½è¯æ˜¯å¦æœ‰æ•ˆã€è‡ªåŠ¨è¯†åˆ«èº«ä»½è¯åŒºåŸŸã€è‡ªåŠ¨è£å‰ªã€è¿”å›æ ‡å‡†åŒ–å›¾ç‰‡ã€‚

è¿‡å»ï¼Œè¿™ç±»éœ€æ±‚è¦ä¹ˆä¾èµ–æœåŠ¡ç«¯ OCRï¼Œè¦ä¹ˆéœ€è¦æ¥ç¬¬ä¸‰æ–¹è¯†åˆ« SDKã€‚ç°åœ¨ï¼Œå¾®ä¿¡å®˜æ–¹åœ¨å°ç¨‹åºä¸­æä¾›äº† VisionKit (VK) è§†è§‰èƒ½åŠ›ï¼Œè®©æˆ‘ä»¬èƒ½åœ¨å‰ç«¯å°±å®Œæˆè¿™ä¸€ç³»åˆ—æ“ä½œã€‚

æœ¬æ–‡å°†å¸¦ä½ ä¸€æ­¥æ­¥å®ç°ï¼šğŸ“· èº«ä»½è¯è‡ªåŠ¨è¯†åˆ« â†’ ğŸ¯ è‡ªåŠ¨è£å‰ª â†’ ğŸ–¼ è¿”å›æ ‡å‡†åŒ– Base64 å›¾ç‰‡ã€‚

## æ•ˆæœç‰¹ç‚¹

### è§†è§‰ç‰¹æ€§

- **è‡ªåŠ¨è¯†åˆ«**ï¼šå‰ç«¯æœ¬åœ°è¯†åˆ«èº«ä»½è¯åŒºåŸŸ
- **é€è§†çŸ«æ­£**ï¼šè‡ªåŠ¨çŸ«æ­£å€¾æ–œçš„èº«ä»½è¯å›¾åƒ
- **æ ‡å‡†åŒ–è¾“å‡º**ï¼šè¿”å›æ ‡å‡†æ¯”ä¾‹çš„èº«ä»½è¯å›¾ç‰‡
- **é«˜æ•ˆå¤„ç†**ï¼šåŸºäº WebGL çš„ GPU åŠ é€Ÿå¤„ç†

### æŠ€æœ¯ç‰¹æ€§

- **æœ¬åœ°å¤„ç†**ï¼šæ— éœ€æœåŠ¡ç«¯æ”¯æŒï¼Œå‰ç«¯ç›´æ¥å®Œæˆè¯†åˆ«
- **é«˜ç²¾åº¦è¯†åˆ«**ï¼šåŸºäºå¾®ä¿¡å®˜æ–¹ VisionKit èƒ½åŠ›
- **ä»¿å°„å˜æ¢**ï¼šåˆ©ç”¨ä»¿å°„çŸ©é˜µå®ç°ç²¾å‡†è£å‰ª
- **Base64 è¾“å‡º**ï¼šç›´æ¥è¿”å›å¤„ç†åçš„å›¾ç‰‡æ•°æ®

## å·¥ä½œåŸç†

```mermaid
graph TD
    A[ç”¨æˆ·ä¸Šä¼ èº«ä»½è¯å›¾ç‰‡] --> B[åˆ›å»ºç¦»å±Canvas]
    B --> C[åŠ è½½å›¾ç‰‡åˆ°Canvas]
    C --> D[è·å–å›¾åƒBuffer]
    D --> E[å¯åŠ¨VKSession]
    E --> F[è°ƒç”¨èº«ä»½è¯æ£€æµ‹]
    F --> G{è¯†åˆ«å®Œæˆ?}
    G -->|å¦| H[ç»§ç»­è¯†åˆ«]
    G -->|æ˜¯| I[è·å–ä»¿å°„çŸ©é˜µ]
    I --> J[åˆ›å»ºè£å‰ªCanvas]
    J --> K[åº”ç”¨ä»¿å°„å˜æ¢]
    K --> L[ç»˜åˆ¶è£å‰ªåŒºåŸŸ]
    L --> M[å¯¼å‡ºBase64å›¾ç‰‡]
    M --> N[è¿”å›å¤„ç†ç»“æœ]
```

## æ ¸å¿ƒå®ç°åŸç†

### 1. åˆå§‹åŒ– VKSession

```javascript
/**
 * åˆå§‹åŒ– VKSession
 */
function createVKSession(gl) {
	const session = wx.createVKSession({
		track: {
			IDCard: { mode: 2 } // ç…§ç‰‡æ¨¡å¼
		},
		version: 'v1',
		gl
	});
	return session;
}
```

- `gl` æ˜¯ WebGL ä¸Šä¸‹æ–‡å¯¹è±¡
- VK ä¼šåŸºäº WebGL åŠ é€Ÿå›¾åƒåˆ†æä¸è¯†åˆ«
- æŒ‡å®š `track: { IDCard: { mode: 2 } }` è¡¨ç¤ºè¯†åˆ«æ¨¡å¼ä¸ºã€Œèº«ä»½è¯ç…§ç‰‡è¯†åˆ«ã€

### 2. æ³¨å†Œè¯†åˆ«äº‹ä»¶

VK çš„è¯†åˆ«ç»“æœä»¥"é”šç‚¹ï¼ˆAnchorï¼‰"å½¢å¼è¿”å›ï¼š

```javascript
session.on("updateAnchors", async (anchors) => { ... })
```

æ¯ä¸ª anchor å°±æ˜¯è¯†åˆ«åˆ°çš„ä¸€ä¸ªèº«ä»½è¯å¯¹è±¡ã€‚é‡ç‚¹å…³æ³¨ `isComplete` å­—æ®µï¼š

```javascript
const anchor = anchors[0];
const isComplete = anchor.isComplete;
if (!isComplete) return resolve(false);
```

åªæœ‰ `isComplete` ä¸º true æ—¶ï¼Œèº«ä»½è¯è¯†åˆ«æ‰ç®—å®Œæˆã€‚

### 3. è·å–ä»¿å°„çŸ©é˜µå¹¶è£å‰ªå›¾åƒ

è¯†åˆ«å®Œæˆåï¼Œä¼šå¾—åˆ°ä»¥ä¸‹å…³é”®ä¿¡æ¯ï¼š

```javascript
const { affineImgWidth, affineImgHeight, affineMat, box } = anchor;
```

å­—æ®µå«ä¹‰ï¼š

| å­—æ®µ                             | å«ä¹‰                     |
| -------------------------------- | ------------------------ |
| affineMat                        | èº«ä»½è¯çš„é€è§†å˜æ¢çŸ©é˜µ     |
| affineImgWidth / affineImgHeight | é€è§†çŸ«æ­£åçš„å›¾åƒå°ºå¯¸     |
| box                              | èº«ä»½è¯åœ¨åŸå›¾ä¸­çš„çŸ©å½¢è¾¹ç•Œ |

åˆ©ç”¨è¿™äº›ä¿¡æ¯ï¼Œé€šè¿‡ `cropIDCard()` å¯¹å›¾åƒè¿›è¡Œä»¿å°„å˜æ¢å’Œè£å‰ªï¼š

```javascript
/**
 * æ ¹æ®ä»¿å°„çŸ©é˜µè£å‰ªèº«ä»½è¯åŒºåŸŸ
 * @param {Image} img åŸå§‹å›¾ç‰‡å¯¹è±¡
 * @param {number} width åŸå›¾å®½åº¦
 * @param {number} height åŸå›¾é«˜åº¦
 * @param {Array<number>} affineMat ä»¿å°„çŸ©é˜µï¼ˆ6ä¸ªæ•°å€¼ï¼‰
 * @param {number} affineImgWidth ç›®æ ‡å›¾å®½
 * @param {number} affineImgHeight ç›®æ ‡å›¾é«˜
 * @returns {string} è£å‰ªåçš„ base64 å›¾ç‰‡
 */
function cropIDCard(img, width, height, affineMat, affineImgWidth, affineImgHeight) {
	// åˆ›å»ºç¦»å± canvas
	const canvas = wx.createOffscreenCanvas({
		type: '2d',
		width: affineImgWidth,
		height: affineImgHeight
	});
	const ctx = canvas.getContext('2d');

	// æ¸…ç©ºç”»å¸ƒ
	ctx.clearRect(0, 0, affineImgWidth, affineImgHeight);

	/**
	 * setTransform(a, b, c, d, e, f)
	 * å¯¹ç»˜åˆ¶å†…å®¹åº”ç”¨ä»¿å°„çŸ©é˜µï¼š
	 * [ a  c  e ]
	 * [ b  d  f ]
	 * [ 0  0  1 ]
	 *
	 * affineMat æ•°ç»„ä¸­å­˜çš„å°±æ˜¯è¿™ä¸ª 3x3 çŸ©é˜µçš„å‰ 6 ä¸ªå…ƒç´ ï¼š
	 * [a, c, e, b, d, f]
	 */
	ctx.setTransform(
		Number(affineMat[0]), // aï¼šæ°´å¹³ç¼©æ”¾
		Number(affineMat[3]), // bï¼šå‚ç›´å€¾æ–œ
		Number(affineMat[1]), // cï¼šæ°´å¹³å€¾æ–œ
		Number(affineMat[4]), // dï¼šå‚ç›´ç¼©æ”¾
		Number(affineMat[2]), // eï¼šæ°´å¹³ä½ç§»
		Number(affineMat[5]) // fï¼šå‚ç›´ä½ç§»
	);

	// ç»˜åˆ¶åŸå›¾ â€”â€” ç»è¿‡çŸ©é˜µå˜æ¢åä¼šåªæ˜¾ç¤ºèº«ä»½è¯åŒºåŸŸ
	ctx.drawImage(img, 0, 0, width, height);

	// å°†è£å‰ªåçš„åŒºåŸŸå¯¼å‡ºä¸º base64
	return canvas.toDataURL();
}
```

#### é€è§†çŸ«æ­£çš„åŸç†

å‡è®¾ç”¨æˆ·æ‹ç…§æ—¶èº«ä»½è¯å€¾æ–œäº†ï¼Œé‚£ä¹ˆåŸå›¾ä¸­çš„èº«ä»½è¯çŸ©å½¢å…¶å®æ˜¯ä¸€ä¸ª"å››è¾¹å½¢"ã€‚VK é€šè¿‡å›¾åƒæ£€æµ‹ç®—æ³•ï¼Œæ¨ç®—å‡ºè¯¥å››è¾¹å½¢ä¸æ ‡å‡†çŸ©å½¢ä¹‹é—´çš„æ˜ å°„å…³ç³»ï¼ˆä»¿å°„çŸ©é˜µï¼‰ã€‚ä½ å¯ä»¥æŠŠ `affineMat` ç†è§£ä¸ºä¸€ä¸ª"å˜æ¢æ¨¡æ¿"ï¼š

- å®ƒèƒ½è®©ä¸€ä¸ªå€¾æ–œçš„çŸ©å½¢è¢«"æ‹‰å¹³"
- åŒæ—¶ä¿æŒå®½é«˜æ¯”
- è¾“å‡ºä¸ºæ ‡å‡†èº«ä»½è¯æ¯”ä¾‹çš„å›¾åƒ

çŸ«æ­£è¿‡ç¨‹ç¤ºæ„ï¼š

```
åŸå›¾ï¼ˆå€¾æ–œï¼‰           â†’      çŸ«æ­£åï¼ˆæ‹‰å¹³ï¼‰
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”               â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ \      â”‚               â”‚        â”‚
â”‚  \     â”‚   å˜æ¢çŸ©é˜µ     â”‚  èº«ä»½è¯ â”‚
â”‚   \    â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶   â”‚        â”‚
â””â”€â”€â”€â”€\â”€â”€â”€â”˜               â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### ä¸ºä»€ä¹ˆç”¨ setTransform() è€Œä¸æ˜¯æ‰‹åŠ¨è®¡ç®—ï¼Ÿ

å› ä¸º `CanvasRenderingContext2D.setTransform()` æœ¬èº«å°±èƒ½ç›´æ¥æ¥æ”¶ä¸€ä¸ªä»¿å°„çŸ©é˜µå¹¶è‡ªåŠ¨å®Œæˆåæ ‡å˜æ¢ã€‚è¿™æ„å‘³ç€æˆ‘ä»¬ä¸éœ€è¦è‡ªå·±è®¡ç®—é€è§†ç‚¹æ˜ å°„æˆ–ä¸‰è§’å½¢æ’å€¼ï¼Œå¾®ä¿¡çš„åº•å±‚ Canvas æ¸²æŸ“å™¨ä¼šç›´æ¥å®Œæˆ GPU åŠ é€Ÿçš„å‡ ä½•å˜æ¢ã€‚

æ¢å¥è¯è¯´ï¼š`affineMat` å°±åƒä¸€æŠŠé’¥åŒ™ï¼Œå‘Šè¯‰ Canvasï¼š"æŠŠèº«ä»½è¯è¿™å—åŒºåŸŸæ‹‰å¹³ã€å±…ä¸­ã€è¾“å‡ºã€‚"æœ€ç»ˆç”Ÿæˆçš„ Base64 å›¾ç‰‡å°±æ˜¯è£å‰ª+é€è§†çŸ«æ­£åçš„èº«ä»½è¯æ ‡å‡†å›¾ã€‚

### 4. æ„å»ºåŸå§‹å›¾åƒ buffer

åœ¨è°ƒç”¨è¯†åˆ«å‰ï¼Œéœ€å…ˆå°†åŸå›¾åŠ è½½è¿›ç¦»å± canvasï¼š

```javascript
const canvas = wx.createOffscreenCanvas({ type: '2d', width, height });
const ctx = canvas.getContext('2d');
const img = canvas.createImage();
await new Promise(r => {
	img.onload = r;
	img.src = imgUrl;
});
ctx.drawImage(img, 0, 0, width, height);
const imgData = ctx.getImageData(0, 0, width, height);
```

è¿™æ ·å°±èƒ½å¾—åˆ°è¯†åˆ«æ‰€éœ€çš„ `frameBuffer`ã€‚

### 5. å¯åŠ¨èº«ä»½è¯æ£€æµ‹

æœ€åï¼Œé€šè¿‡ `session.start()` å¯åŠ¨è¯†åˆ«ï¼š

```javascript
session.start(() => {
	session.detectIDCard({
		frameBuffer: imgData.data.buffer,
		width,
		height,
		getAffineImg: true
	});
});
```

VK ä¼šåœ¨åå°è‡ªåŠ¨åˆ†æå›¾åƒï¼Œå½“è¯†åˆ«åˆ°èº«ä»½è¯åè§¦å‘ `updateAnchors` å›è°ƒã€‚

## å®Œæ•´ä»£ç å®ç°

```javascript
/**
 * åˆå§‹åŒ– VKSession
 */
function createVKSession(gl) {
  const session = wx.createVKSession({
    track: {
      IDCard: { mode: 2 }, // ç…§ç‰‡æ¨¡å¼
    },
    version: "v1",
    gl,
  })
  return session
}

/**
 * æ ¹æ®ä»¿å°„çŸ©é˜µè£å‰ªèº«ä»½è¯åŒºåŸŸ
 * @param {Image} img åŸå§‹å›¾ç‰‡å¯¹è±¡
 * @param {number} width åŸå›¾å®½åº¦
 * @param {number} height åŸå›¾é«˜åº¦
 * @param {Array<number>} affineMat ä»¿å°„çŸ©é˜µï¼ˆ6ä¸ªæ•°å€¼ï¼‰
 * @param {number} affineImgWidth ç›®æ ‡å›¾å®½
 * @param {number} affineImgHeight ç›®æ ‡å›¾é«˜
 * @returns {string} è£å‰ªåçš„ base64 å›¾ç‰‡
 */
function cropIDCard(img, width, height, affineMat, affineImgWidth, affineImgHeight) {
  // åˆ›å»ºç¦»å± canvas
  const canvas = wx.createOffscreenCanvas({
    type: "2d",
    width: affineImgWidth,
    height: affineImgHeight,
  })
  const ctx = canvas.getContext("2d")

  // æ¸…ç©ºç”»å¸ƒ
  ctx.clearRect(0, 0, affineImgWidth, affineImgHeight)

  /**
   * setTransform(a, b, c, d, e, f)
   * å¯¹ç»˜åˆ¶å†…å®¹åº”ç”¨ä»¿å°„çŸ©é˜µï¼š
   * [ a  c  e ]
   * [ b  d  f ]
   * [ 0  0  1 ]
   *
   * affineMat æ•°ç»„ä¸­å­˜çš„å°±æ˜¯è¿™ä¸ª 3x3 çŸ©é˜µçš„å‰ 6 ä¸ªå…ƒç´ ï¼š
   * [a, c, e, b, d, f]
   */
  ctx.setTransform(
    Number(affineMat[0]), // aï¼šæ°´å¹³ç¼©æ”¾
    Number(affineMat[3]), // bï¼šå‚ç›´å€¾æ–œ
    Number(affineMat[1]), // cï¼šæ°´å¹³å€¾æ–œ
    Number(affineMat[4]), // dï¼šå‚ç›´ç¼©æ”¾
    Number(affineMat[2]), // eï¼šæ°´å¹³ä½ç§»
    Number(affineMat[5])  // fï¼šå‚ç›´ä½ç§»
  )

  // ç»˜åˆ¶åŸå›¾ â€”â€” ç»è¿‡çŸ©é˜µå˜æ¢åä¼šåªæ˜¾ç¤ºèº«ä»½è¯åŒºåŸŸ
  ctx.drawImage(img, 0, 0, width, height)

  // å°†è£å‰ªåçš„åŒºåŸŸå¯¼å‡ºä¸º base64
  return canvas.toDataURL()
}

/**
 * å°† base64 è½¬ä¸ºå°ç¨‹åºä¸´æ—¶æ–‡ä»¶è·¯å¾„
 */
function base64ToTempFilePath(base64Data) {
  const base64 = base64Data
  const time = new Date().getTime()
  const imgPath = wx.env.USER_DATA_PATH + "/poster" + time + "share" + ".png"
  const imageData = base64.replace(/^data:image/\w+;base64,/, "")
  const file = wx.getFileSystemManager()
  file.writeFileSync(imgPath, imageData, "base64")
  return imgPath
}

/**
 * è¯†åˆ«èº«ä»½è¯å¹¶è¿”å›è£å‰ªåçš„ base64
 * @param {Object} options
 * @param {string} options.imgUrl å›¾ç‰‡è·¯å¾„
 * @param {number} options.width åŸå›¾å®½
 * @param {number} options.height åŸå›¾é«˜
 * @param {*} options.gl å°ç¨‹åº gl å¯¹è±¡
 * @returns {Promise<string>} base64
 */
function detectIDCard({ imgUrl, width, height, gl }) {
  return new Promise(async (resolve, reject) => {
    try {
      const session = createVKSession(gl)

      // ç›‘å¬è¯†åˆ«ç»“æœ
      session.on("updateAnchors", async (anchors) => {
        if (anchors && anchors[0]) {
          const anchor = anchors[0]
          const isComplete = anchor.isComplete
          if (!isComplete) return resolve(false)
          const { affineImgWidth, affineImgHeight, affineMat, box } = anchor
          if (affineImgWidth && affineImgHeight && affineMat) {
            const cropImg = cropIDCard(
              img,
              width,
              height,
              affineMat,
              affineImgWidth,
              affineImgHeight
            )
            resolve({
              cropImg: base64ToTempFilePath(cropImg),
              affineImgWidth,
              affineImgHeight,
              box,
            })
          } else {
            resolve(false)
          }
        } else {
          resolve(false)
        }
      })

      // æœªè¯†åˆ«åˆ°èº«ä»½è¯
      session.on("removeAnchors", () => {
        resolve(false)
      })

      // å‡†å¤‡å›¾ç‰‡ buffer
      const canvas = wx.createOffscreenCanvas({
        type: "2d",
        width,
        height,
      })
      const ctx = canvas.getContext("2d")
      const img = canvas.createImage()
      await new Promise((r) => {
        img.onload = r
        img.src = imgUrl
      })
      ctx.drawImage(img, 0, 0, width, height)
      const imgData = ctx.getImageData(0, 0, width, height)

      // å¯åŠ¨è¯†åˆ«
      session.start(() => {
        session.detectIDCard({
          frameBuffer: imgData.data.buffer,
          width,
          height,
          getAffineImg: true,
        })
      })
    } catch (err) {
      reject(err)
    }
  })
}

module.exports = {
  detectIDCard,
}
```

## VisionKit åŸç†æ¦‚è¿°

`createVKSession(gl)` æ˜¯å¾®ä¿¡å°ç¨‹åºå†…ç½®çš„ AR/è§†è§‰è¯†åˆ«æ¥å£ã€‚å®ƒçš„æ ¸å¿ƒèƒ½åŠ›åŒ…æ‹¬ï¼š

- ğŸ“· å›¾åƒå¯¹è±¡æ£€æµ‹ï¼ˆå¦‚èº«ä»½è¯ã€äººè„¸ã€åç‰‡ï¼‰
- ğŸ§  GPU åŠ é€Ÿçš„çŸ©é˜µè®¡ç®—ä¸é€è§†å˜æ¢
- ğŸ§© è¿”å›é”šç‚¹å¯¹è±¡ï¼ˆAnchorï¼‰ï¼ŒåŒ…å«è¯†åˆ«åŒºåŸŸã€çŸ©é˜µã€å®Œæ•´åº¦çŠ¶æ€ç­‰

å¸¸ç”¨äº‹ä»¶å¦‚ä¸‹ï¼š

| äº‹ä»¶å        | å«ä¹‰                             |
| ------------- | -------------------------------- |
| updateAnchors | æ£€æµ‹åˆ°æ–°èº«ä»½è¯æˆ–è¯†åˆ«è¿›åº¦æ›´æ–°     |
| removeAnchors | è¯†åˆ«ç»“æœè¢«ç§»é™¤ï¼ˆæœªæ£€æµ‹åˆ°èº«ä»½è¯ï¼‰ |

## è‡ªå®šä¹‰å‚æ•°è¯´æ˜

åœ¨å®é™…ä½¿ç”¨ä¸­ï¼Œå¯ä»¥æ ¹æ®éœ€æ±‚è°ƒæ•´ä»¥ä¸‹å‚æ•°ï¼š

### 1. è¯†åˆ«æ¨¡å¼é…ç½®

```javascript
const session = wx.createVKSession({
	track: {
		IDCard: { mode: 2 } // ç…§ç‰‡æ¨¡å¼
	},
	version: 'v1',
	gl
});
```

- `mode: 2` è¡¨ç¤ºç…§ç‰‡æ¨¡å¼ï¼Œé€‚ç”¨äºé™æ€å›¾ç‰‡è¯†åˆ«
- `mode: 1` è¡¨ç¤ºè§†é¢‘æµæ¨¡å¼ï¼Œé€‚ç”¨äºå®æ—¶æ‘„åƒå¤´è¯†åˆ«

### 2. å›¾åƒè´¨é‡å‚æ•°

```javascript
session.detectIDCard({
	frameBuffer: imgData.data.buffer,
	width,
	height,
	getAffineImg: true
});
```

- `getAffineImg: true` è¡¨ç¤ºéœ€è¦è·å–ä»¿å°„å˜æ¢çŸ©é˜µï¼Œç”¨äºå›¾åƒè£å‰ª
- å¯ä»¥æ ¹æ®éœ€è¦è°ƒæ•´å›¾åƒå°ºå¯¸ä»¥å¹³è¡¡è¯†åˆ«ç²¾åº¦å’Œæ€§èƒ½

## åº”ç”¨åœºæ™¯

### 1. å®åè®¤è¯æµç¨‹

```javascript
// ç”¨æˆ·ä¸Šä¼ èº«ä»½è¯åè‡ªåŠ¨å¤„ç†
wx.chooseImage({
	count: 1,
	success: async res => {
		const imgUrl = res.tempFilePaths[0];
		// è·å–å›¾ç‰‡ä¿¡æ¯
		const { width, height } = await getImageInfo(imgUrl);
		// åˆå§‹åŒ– WebGL ä¸Šä¸‹æ–‡
		const gl = createWebGLContext();
		// è¯†åˆ«å¹¶è£å‰ªèº«ä»½è¯
		const result = await detectIDCard({ imgUrl, width, height, gl });
		if (result) {
			// ä¸Šä¼ å¤„ç†åçš„èº«ä»½è¯å›¾ç‰‡
			uploadIDCardImage(result.cropImg);
		}
	}
});
```

### 2. èº«ä»½è¯ä¿¡æ¯æå–

ç»“åˆ OCR æŠ€æœ¯ï¼Œå¯ä»¥è¿›ä¸€æ­¥æå–èº«ä»½è¯ä¸Šçš„æ–‡å­—ä¿¡æ¯ï¼š

```javascript
// åœ¨è£å‰ªåçš„èº«ä»½è¯å›¾ç‰‡ä¸Šè¿›è¡Œ OCR è¯†åˆ«
const idCardInfo = await ocrIDCard(result.cropImg);
console.log('å§“å:', idCardInfo.name);
console.log('èº«ä»½è¯å·:', idCardInfo.idNumber);
console.log('å‡ºç”Ÿæ—¥æœŸ:', idCardInfo.birthDate);
```

## æ€§èƒ½ä¼˜åŒ–å»ºè®®

### 1. å›¾åƒå°ºå¯¸ä¼˜åŒ–

```javascript
// é™åˆ¶å›¾åƒå°ºå¯¸ä»¥æé«˜å¤„ç†é€Ÿåº¦
const MAX_WIDTH = 1000;
const scale = Math.min(1, MAX_WIDTH / originalWidth);
const width = Math.floor(originalWidth * scale);
const height = Math.floor(originalHeight * scale);
```

### 2. å¼‚å¸¸å¤„ç†

```javascript
try {
	const result = await detectIDCard({ imgUrl, width, height, gl });
	if (!result) {
		wx.showToast({ title: 'æœªè¯†åˆ«åˆ°èº«ä»½è¯', icon: 'none' });
	}
} catch (error) {
	wx.showToast({ title: 'è¯†åˆ«å¤±è´¥ï¼Œè¯·é‡è¯•', icon: 'none' });
}
```

## å®‰å…¨è€ƒè™‘

### 1. ç”¨æˆ·éšç§ä¿æŠ¤

- èº«ä»½è¯è¯†åˆ«åœ¨æœ¬åœ°å®Œæˆï¼Œä¸ä¸Šä¼ ç”¨æˆ·å›¾ç‰‡åˆ°æœåŠ¡å™¨
- å¤„ç†åçš„å›¾ç‰‡æ•°æ®ä¹Ÿåº”å¦¥å–„ä¿ç®¡ï¼Œé¿å…æ³„éœ²

### 2. æ•°æ®éªŒè¯

```javascript
// éªŒè¯è¯†åˆ«ç»“æœçš„å®Œæ•´æ€§
if (result && result.box && result.affineMat) {
	// è¿›ä¸€æ­¥éªŒè¯èº«ä»½è¯ä¿¡æ¯
	validateIDCardInfo(result);
}
```

## æ•…éšœæ’é™¤

### 1. è¯†åˆ«å¤±è´¥

**é—®é¢˜**: æ— æ³•è¯†åˆ«èº«ä»½è¯æˆ–è¯†åˆ«ç»“æœä¸å‡†ç¡®
**è§£å†³æ–¹æ¡ˆ**:

- æ£€æŸ¥å›¾ç‰‡è´¨é‡ï¼Œç¡®ä¿æ¸…æ™°åº¦è¶³å¤Ÿ
- ç¡®è®¤èº«ä»½è¯å®Œæ•´æ˜¾ç¤ºåœ¨å›¾ç‰‡ä¸­
- éªŒè¯ WebGL ç¯å¢ƒæ˜¯å¦æ­£å¸¸åˆå§‹åŒ–

### 2. è£å‰ªå¼‚å¸¸

**é—®é¢˜**: è£å‰ªåçš„å›¾ç‰‡å˜å½¢æˆ–ä¸å®Œæ•´
**è§£å†³æ–¹æ¡ˆ**:

- æ£€æŸ¥ä»¿å°„çŸ©é˜µå‚æ•°æ˜¯å¦æ­£ç¡®ä¼ é€’
- éªŒè¯ Canvas å°ºå¯¸è®¾ç½®æ˜¯å¦æ­£ç¡®
- ç¡®è®¤å›¾ç‰‡åŠ è½½æ˜¯å¦å®Œæˆ

## æ€»ç»“

é€šè¿‡å¾®ä¿¡å°ç¨‹åºçš„ VisionKitï¼Œæˆ‘ä»¬å¯ä»¥åœ¨å‰ç«¯æœ¬åœ°å®Œæˆèº«ä»½è¯è¯†åˆ«ä¸è£å‰ªçš„å®Œæ•´æµç¨‹ï¼š

1. **å›¾åƒåŠ è½½**ï¼šå°†ç”¨æˆ·ä¸Šä¼ çš„èº«ä»½è¯å›¾ç‰‡åŠ è½½åˆ°ç¦»å± Canvas
2. **ç‰¹å¾è¯†åˆ«**ï¼šåˆ©ç”¨ VK çš„èº«ä»½è¯æ£€æµ‹èƒ½åŠ›è¯†åˆ«èº«ä»½è¯åŒºåŸŸ
3. **é€è§†çŸ«æ­£**ï¼šé€šè¿‡ä»¿å°„å˜æ¢çŸ©é˜µçŸ«æ­£å€¾æ–œçš„èº«ä»½è¯å›¾åƒ
4. **å›¾åƒè£å‰ª**ï¼šæå–æ ‡å‡†åŒ–çš„èº«ä»½è¯å›¾ç‰‡
5. **ç»“æœè¾“å‡º**ï¼šè¿”å›å¤„ç†åçš„ Base64 å›¾ç‰‡æ•°æ®

è¿™ä¸€æ–¹æ¡ˆç›¸æ¯”ä¼ ç»Ÿçš„æœåŠ¡ç«¯ OCR æ–¹æ¡ˆæœ‰ä»¥ä¸‹ä¼˜åŠ¿ï¼š

- **å“åº”é€Ÿåº¦å¿«**ï¼šæœ¬åœ°å¤„ç†ï¼Œæ— éœ€ç½‘ç»œä¼ è¾“
- **æˆæœ¬ä½**ï¼šæ— éœ€é¢å¤–çš„æœåŠ¡ç«¯èµ„æº
- **éšç§ä¿æŠ¤**ï¼šç”¨æˆ·å›¾ç‰‡ä¸ç¦»å¼€è®¾å¤‡
- **ç”¨æˆ·ä½“éªŒå¥½**ï¼šå®æ—¶åé¦ˆè¯†åˆ«ç»“æœ

éšç€å¾®ä¿¡å°ç¨‹åºèƒ½åŠ›çš„ä¸æ–­å®Œå–„ï¼ŒåŸºäº VisionKit çš„å›¾åƒè¯†åˆ«æ–¹æ¡ˆå°†åœ¨æ›´å¤šåœºæ™¯ä¸­å‘æŒ¥é‡è¦ä½œç”¨ã€‚
