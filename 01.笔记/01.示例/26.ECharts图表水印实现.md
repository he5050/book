---
title: ECharts图表水印实现
date: 2025-09-25
permalink: /notes/echarts-watermark
categories:
  - 笔记
  - 示例
---

# ECharts 图表水印实现

## 简介

在数据可视化项目中，保护图表数据的安全性和版权是非常重要的。ECharts 图表水印是一种专门为 ECharts 图表设计的水印解决方案，它将水印集成到图表的背景中，既能起到防护作用，又不会影响图表的正常交互。

## 方案特点

### 优势

1. **专门针对图表优化**：完美解决了图表场景下的水印需求，不会影响图表交互和美观
2. **导出图片自带水印**：省去了导出后手动加水印的麻烦，保证了导出内容的完整性
3. **不影响图表交互**：用户可以像往常一样操作图表，水印不会成为障碍
4. **视觉效果自然**：水印与图表背景融为一体，不会显得突兀，提升了整体的专业感

### 局限性

1. **仅适用于图表场景**：这个方案的局限性在于，它只能用于 ECharts 图表，无法应用于整个页面或非图表区域
2. **依赖 ECharts 库**：如果你的项目没有使用 ECharts，那么为了水印而引入 ECharts 显然是不划算的
3. **定制化程度有限**：虽然可以通过 Canvas 绘制出各种图案，但相对于自定义 Canvas 方案，它在与 ECharts 结合时，对水印的动态变化和复杂交互的定制能力会受到一定限制

## 实现原理

ECharts 图表水印的实现原理与自定义 Canvas 水印有异曲同工之妙，都是利用 Canvas 绘制水印图案。不同的是，这里我们将 Canvas 绘制出的图案作为 ECharts 图表的 backgroundColor，通过 `type: 'pattern'` 和 `image: canvas` 的方式，让水印图案在图表背景中重复平铺。

### 核心代码结构

```javascript
// 创建水印 Canvas
const canvas = document.createElement('canvas');
const ctx = canvas.getContext('2d');

// 配置 Canvas 尺寸
canvas.width = canvas.height = 100;

// 配置文字样式
ctx.textAlign = 'center';
ctx.textBaseline = 'middle';
ctx.globalAlpha = 0.08; // 设置水印透明度
ctx.font = '20px Microsoft Yahei';

// 设置文字位置和角度
ctx.translate(50, 50);
ctx.rotate(-Math.PI / 4); // 逆时针旋转 45 度

// 绘制水印文字
ctx.fillText('WATERMARK', 0, 0);

// ECharts 配置
const option = {
	// 使用水印作为背景
	backgroundColor: {
		type: 'pattern', // 背景类型为图案
		image: canvas, // 使用我们绘制的 Canvas 作为图案来源
		repeat: 'repeat' // 图案重复平铺
	}
	// 其他图表配置...
};
```

## React 组件实现

### 核心组件代码

```tsx
import React, { useEffect, useRef } from 'react';
import * as echarts from 'echarts';

const EchartsWatermark: React.FC = () => {
	const chartRef = useRef<HTMLDivElement>(null);
	const chartInstanceRef = useRef<echarts.ECharts | null>(null);

	useEffect(() => {
		if (!chartRef.current) return;

		// 创建水印 Canvas
		const createWatermarkCanvas = () => {
			const canvas = document.createElement('canvas');
			const ctx = canvas.getContext('2d');

			if (!ctx) return canvas;

			// 设置 Canvas 尺寸，决定水印图案的大小和重复密度
			canvas.width = canvas.height = 100;

			// 配置文字样式
			ctx.textAlign = 'center';
			ctx.textBaseline = 'middle';
			ctx.globalAlpha = 0.08; // 设置水印透明度，使其不影响图表内容的阅读
			ctx.font = '20px Microsoft Yahei, sans-serif';

			// 设置文字位置和角度
			ctx.translate(50, 50); // 将 Canvas 原点移动到中心，方便旋转和绘制
			ctx.rotate(-Math.PI / 4); // 逆时针旋转 45 度，使水印倾斜

			// 绘制水印文字
			ctx.fillText('ECHARTS', 0, 0); // 在 Canvas 中心绘制水印文字

			return canvas;
		};

		// 初始化图表
		const initChart = () => {
			if (chartRef.current) {
				// 销毁之前的实例（如果存在）
				if (chartInstanceRef.current) {
					chartInstanceRef.current.dispose();
				}

				// 创建水印 Canvas
				const watermarkCanvas = createWatermarkCanvas();

				// 初始化新的 echarts 实例
				chartInstanceRef.current = echarts.init(chartRef.current);

				// 图表数据，这里只是一个示例数据
				const builderJson = {
					all: 10887,
					charts: {
						map: 3237,
						lines: 2164,
						bar: 7561,
						pie: 6354,
						scatter: 4212,
						radar: 3123,
						tree: 1234,
						treemap: 2134,
						sunburst: 1243,
						boxplot: 2341
					}
				};

				// ECharts 配置
				const option: echarts.EChartsOption = {
					// 使用水印作为背景！这是关键！
					backgroundColor: {
						type: 'pattern', // 背景类型为图案
						image: watermarkCanvas, // 使用我们绘制的 Canvas 作为图案来源
						repeat: 'repeat' // 图案重复平铺
					},

					// 图表配置，这里只是一个简单的柱状图示例
					tooltip: {},
					title: [
						{
							text: '在线构建',
							subtext: '总计 ' + builderJson.all,
							left: '25%',
							textAlign: 'center'
						},
						{
							text: '各图表类型',
							subtext: '总计 ' + Object.keys(builderJson.charts).length,
							left: '75%',
							textAlign: 'center'
						}
					],

					// 系列数据
					series: [
						{
							type: 'bar',
							data: Object.keys(builderJson.charts).map(key => ({
								name: key,
								value: builderJson.charts[key as keyof typeof builderJson.charts]
							})),
							itemStyle: {
								color: '#409EFF'
							}
						}
					],

					xAxis: {
						type: 'category',
						data: Object.keys(builderJson.charts)
					},

					yAxis: {
						type: 'value'
					}
				};

				// 设置配置项
				chartInstanceRef.current.setOption(option);

				// 响应式处理，确保图表在窗口大小变化时能正确重绘
				const handleResize = () => {
					chartInstanceRef.current?.resize();
				};

				window.addEventListener('resize', handleResize);

				// 清理函数
				return () => {
					window.removeEventListener('resize', handleResize);
				};
			}
		};

		// 初始化图表
		initChart();

		// 组件卸载时清理
		return () => {
			if (chartInstanceRef.current) {
				chartInstanceRef.current.dispose();
				chartInstanceRef.current = null;
			}
		};
	}, []);

	return (
		<div className="echarts-watermark-demo" style={{ padding: '20px' }}>
			<h2 style={{ marginBottom: '20px', color: '#333' }}>ECharts 图表水印示例</h2>
			<div ref={chartRef} style={{ width: '100%', height: '400px' }} />

			<div className="instructions" style={{ marginTop: '20px' }}>
				<h3 style={{ color: '#333', margin: '15px 0 10px' }}>使用说明：</h3>
				<ol style={{ paddingLeft: '20px' }}>
					<li style={{ margin: '8px 0' }}>水印已集成到图表背景中，不影响图表交互</li>
					<li style={{ margin: '8px 0' }}>导出图表图片时，水印会自动包含在内</li>
					<li style={{ margin: '8px 0' }}>水印透明度较低，不会影响图表内容阅读</li>
				</ol>

				<h3 style={{ color: '#333', margin: '15px 0 10px' }}>核心特性：</h3>
				<ul style={{ paddingLeft: '20px' }}>
					<li style={{ margin: '8px 0' }}>✅ 专门针对图表优化</li>
					<li style={{ margin: '8px 0' }}>✅ 导出图片自带水印</li>
					<li style={{ margin: '8px 0' }}>✅ 不影响图表交互</li>
					<li style={{ margin: '8px 0' }}>✅ 视觉效果自然</li>
				</ul>
			</div>
		</div>
	);
};

export default EchartsWatermark;
```

### 完整示例

<demo react="react/Watermark/EchartsWatermark.tsx" 
:reactFiles="['react/Watermark/EchartsWatermark.tsx']" 
/>

### 测试组件

```tsx
import React from 'react';
import EchartsWatermark from './EchartsWatermark';

const TestEchartsWatermark: React.FC = () => {
	return (
		<div style={{ padding: '20px', backgroundColor: '#f5f5f5', minHeight: '100vh' }}>
			<h1 style={{ textAlign: 'center', color: '#333' }}>ECharts 水印组件测试</h1>
			<div
				style={{
					backgroundColor: '#fff',
					padding: '20px',
					borderRadius: '8px',
					boxShadow: '0 2px 8px rgba(0,0,0,0.1)'
				}}
			>
				<EchartsWatermark />
			</div>
		</div>
	);
};

export default TestEchartsWatermark;
```

## 方案对比

| 特性       | 自定义 Canvas | ECharts 图表 |
| ---------- | ------------- | ------------ |
| 实现难度   | ⭐⭐⭐⭐      | ⭐⭐         |
| 防篡改能力 | ⭐⭐⭐⭐⭐    | ⭐⭐⭐       |
| 定制化程度 | ⭐⭐⭐⭐⭐    | ⭐⭐⭐       |
| 性能表现   | ⭐⭐⭐        | ⭐⭐⭐⭐     |
| 通用性     | ⭐⭐⭐⭐⭐    | ⭐⭐         |
| 维护成本   | ⭐⭐          | ⭐⭐⭐⭐     |

## 最佳实践建议

### 选择合适的方案

1. **高安全性项目**：自定义 Canvas 方案

   - 适用于对水印安全性要求极高的项目，如金融、政府等敏感领域

2. **数据可视化项目**：ECharts 图表水印方案
   - 专门针对 ECharts 图表优化，适用于大量使用图表的数据可视化项目

### 使用建议

1. **合理设置透明度**：水印透明度应设置得较低（0.05-0.15），以免影响图表内容的阅读
2. **选择合适的字体**：使用系统默认字体或确保字体在所有设备上都能正常显示
3. **控制水印密度**：通过调整 Canvas 尺寸控制水印的重复密度，避免过于密集
4. **考虑导出需求**：ECharts 图表水印在导出图片时会自动包含，这是其独特优势

## 结语

ECharts 图表水印方案是数据可视化项目中不可多得的利器。它以一种优雅而高效的方式，为你的数据图表加上了一层独特的"身份标识"，让你的数据成果在传播过程中得到更好的保护。

在实际项目中，我们可以根据具体需求选择合适的水印方案，甚至可以结合多种方案实现更全面的保护。例如，在整个页面使用自定义 Canvas 水印作为基础保护，同时在重要的 ECharts 图表中使用图表水印以确保导出内容的安全性。
