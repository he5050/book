---
title: 6.masonry.js å®ç°ç€‘å¸ƒæµ
date: 2025-07-14 21:43:00
permalink: /notes/masonry
categories:
  - ç¬”è®°
tags:
  - JS
  - ç€‘å¸ƒæµ
---

# ç€‘å¸ƒæµå¸ƒå±€å®ç°æŒ‡å—

ç€‘å¸ƒæµï¼ˆMasonry Layoutï¼‰æ˜¯ä¸€ç§æµè¡Œçš„ç½‘é¡µå¸ƒå±€æ–¹å¼ï¼Œç‰¹åˆ«é€‚ç”¨äºå±•ç¤ºä¸åŒé«˜åº¦çš„å†…å®¹å¡ç‰‡ï¼Œå¦‚å›¾ç‰‡ç”»å»Šã€æ–‡ç« åˆ—è¡¨ã€äº§å“å±•ç¤ºç­‰ã€‚æœ¬æ–‡å°†ä»‹ç»å¤šç§å®ç°ç€‘å¸ƒæµçš„æ–¹æ³•ã€‚

## ğŸ¯ ç€‘å¸ƒæµç‰¹ç‚¹

- **è‡ªé€‚åº”é«˜åº¦**: å†…å®¹å—æ ¹æ®å®é™…å†…å®¹è‡ªåŠ¨è°ƒæ•´é«˜åº¦
- **ç´§å¯†æ’åˆ—**: æœ€å°åŒ–ç©ºç™½åŒºåŸŸï¼Œæé«˜ç©ºé—´åˆ©ç”¨ç‡
- **å“åº”å¼è®¾è®¡**: æ ¹æ®å±å¹•å®½åº¦è‡ªåŠ¨è°ƒæ•´åˆ—æ•°
- **è§†è§‰ç¾è§‚**: åˆ›é€ ä¸è§„åˆ™ä½†å’Œè°çš„è§†è§‰æ•ˆæœ

## ğŸ› ï¸ å®ç°æ–¹æ¡ˆå¯¹æ¯”

| æ–¹æ¡ˆ | ä¼˜ç‚¹ | ç¼ºç‚¹ | é€‚ç”¨åœºæ™¯ |
|------|------|------|----------|
| **Masonry.js** | åŠŸèƒ½å®Œå–„ï¼Œé…ç½®çµæ´» | éœ€è¦ JavaScriptï¼Œä½“ç§¯è¾ƒå¤§ | å¤æ‚äº¤äº’éœ€æ±‚ |
| **CSS Grid** | çº¯ CSS å®ç°ï¼Œæ€§èƒ½å¥½ | æµè§ˆå™¨å…¼å®¹æ€§è¦æ±‚é«˜ | ç°ä»£æµè§ˆå™¨é¡¹ç›® |
| **CSS Flexbox** | å…¼å®¹æ€§å¥½ï¼Œå®ç°ç®€å• | éœ€è¦é¢„çŸ¥å†…å®¹é«˜åº¦ | ç®€å•å¸ƒå±€éœ€æ±‚ |
| **CSS Columns** | ä»£ç ç®€æ´ï¼Œè‡ªåŠ¨åˆ†åˆ— | é˜…è¯»é¡ºåºé—®é¢˜ | æ–‡æœ¬å†…å®¹å±•ç¤º |

## ğŸ“š Masonry.js å®ç°

### åŸºç¡€ç”¨æ³•

<demo react="react/Masonry/index.tsx" 
:reactFiles="['react/Masonry/index.tsx','react/Masonry/MasonryImageGallery.tsx','react/Masonry/PreviewModal.tsx','react/Masonry/PreviewProvider.tsx']" 
/>

**æ ¸å¿ƒç‰¹æ€§**ï¼š
- è‡ªåŠ¨è®¡ç®—æœ€ä½³ä½ç½®
- æ”¯æŒå“åº”å¼æ–­ç‚¹
- ä¸°å¯Œçš„é…ç½®é€‰é¡¹
- åŠ¨ç”»è¿‡æ¸¡æ•ˆæœ

### é…ç½®é€‰é¡¹è¯¦è§£

```javascript
// Masonry é…ç½®ç¤ºä¾‹
const masonryOptions = {
  // åˆ—å®½è®¾ç½®
  columnWidth: 200,        // å›ºå®šåˆ—å®½
  columnWidth: '.grid-sizer', // ä½¿ç”¨å…ƒç´ ä½œä¸ºåˆ—å®½å‚è€ƒ
  
  // é—´è·è®¾ç½®
  gutter: 10,              // å›ºå®šé—´è·
  gutter: '.gutter-sizer', // ä½¿ç”¨å…ƒç´ ä½œä¸ºé—´è·å‚è€ƒ
  
  // å“åº”å¼è®¾ç½®
  fitWidth: true,          // å®¹å™¨å®½åº¦è‡ªé€‚åº”
  
  // åŠ¨ç”»è®¾ç½®
  transitionDuration: '0.4s', // è¿‡æ¸¡åŠ¨ç”»æ—¶é•¿
  
  // æ’åºè®¾ç½®
  horizontalOrder: true,   // ä¿æŒæ°´å¹³é¡ºåº
  
  // ç™¾åˆ†æ¯”å®½åº¦
  percentPosition: true    // ä½¿ç”¨ç™¾åˆ†æ¯”å®šä½
};
```

## ğŸ¨ CSS Grid å®ç°

### ç°ä»£ CSS æ–¹æ¡ˆ

```css
.masonry-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
  grid-gap: 20px;
  grid-auto-rows: 10px; /* è®¾ç½®å¾ˆå°çš„è¡Œé«˜ */
}

.masonry-item {
  /* æ ¹æ®å†…å®¹é«˜åº¦åŠ¨æ€è®¾ç½®è·¨è¶Šçš„è¡Œæ•° */
  grid-row-end: span var(--row-span);
}
```

```javascript
// JavaScript è®¡ç®—è¡Œè·¨åº¦
function setGridRowSpan() {
  const items = document.querySelectorAll('.masonry-item');
  items.forEach(item => {
    const height = item.offsetHeight;
    const rowSpan = Math.ceil(height / 10); // 10px æ˜¯ grid-auto-rows çš„å€¼
    item.style.setProperty('--row-span', rowSpan);
  });
}
```

### CSS Grid ä¼˜åŠ¿
- **æ€§èƒ½ä¼˜å¼‚**: æµè§ˆå™¨åŸç”Ÿæ”¯æŒï¼Œæ¸²æŸ“æ•ˆç‡é«˜
- **å“åº”å¼å‹å¥½**: è‡ªåŠ¨é€‚åº”å®¹å™¨å®½åº¦
- **ä»£ç ç®€æ´**: ç›¸å¯¹è¾ƒå°‘çš„ CSS ä»£ç 

## ğŸ”§ CSS Flexbox å®ç°

### å¤šåˆ— Flexbox æ–¹æ¡ˆ

```css
.masonry-container {
  display: flex;
  flex-direction: row;
  gap: 20px;
}

.masonry-column {
  flex: 1;
  display: flex;
  flex-direction: column;
  gap: 20px;
}
```

```javascript
// JavaScript åˆ†é…å†…å®¹åˆ°åˆ—
function distributeItems() {
  const container = document.querySelector('.masonry-container');
  const items = Array.from(document.querySelectorAll('.masonry-item'));
  const columnCount = 3; // åˆ—æ•°
  
  // åˆ›å»ºåˆ—
  for (let i = 0; i < columnCount; i++) {
    const column = document.createElement('div');
    column.className = 'masonry-column';
    container.appendChild(column);
  }
  
  const columns = document.querySelectorAll('.masonry-column');
  
  // åˆ†é…é¡¹ç›®åˆ°é«˜åº¦æœ€å°çš„åˆ—
  items.forEach(item => {
    const shortestColumn = Array.from(columns).reduce((prev, current) => 
      prev.offsetHeight < current.offsetHeight ? prev : current
    );
    shortestColumn.appendChild(item);
  });
}
```

## ğŸ“± å“åº”å¼è®¾è®¡

### æ–­ç‚¹é…ç½®

```javascript
// Masonry.js å“åº”å¼é…ç½®
const responsiveOptions = {
  breakpoints: {
    1200: {
      columnWidth: 300,
      gutter: 20
    },
    768: {
      columnWidth: 250,
      gutter: 15
    },
    480: {
      columnWidth: '100%',
      gutter: 10
    }
  }
};
```

### CSS åª’ä½“æŸ¥è¯¢

```css
/* æ¡Œé¢ç«¯ */
@media (min-width: 1200px) {
  .masonry-grid {
    grid-template-columns: repeat(4, 1fr);
  }
}

/* å¹³æ¿ç«¯ */
@media (min-width: 768px) and (max-width: 1199px) {
  .masonry-grid {
    grid-template-columns: repeat(3, 1fr);
  }
}

/* ç§»åŠ¨ç«¯ */
@media (max-width: 767px) {
  .masonry-grid {
    grid-template-columns: repeat(2, 1fr);
  }
}
```

## ğŸ–¼ï¸ å›¾ç‰‡ç”»å»Šå¢å¼º

### LightBox é›†æˆ

<demo react="react/LightBox/index.tsx" 
:reactFiles="['react/LightBox/index.tsx','react/LightBox/Gallery.tsx','react/LightBox/Lightbox.tsx']" 
/>

**å¢å¼ºåŠŸèƒ½**ï¼š
- å›¾ç‰‡é¢„è§ˆæ”¾å¤§
- é”®ç›˜å¯¼èˆªæ”¯æŒ
- è§¦æ‘¸æ‰‹åŠ¿æ”¯æŒ
- ç¼©ç•¥å›¾å¯¼èˆª

### æ‡’åŠ è½½ä¼˜åŒ–

```javascript
// Intersection Observer å®ç°æ‡’åŠ è½½
const imageObserver = new IntersectionObserver((entries) => {
  entries.forEach(entry => {
    if (entry.isIntersecting) {
      const img = entry.target;
      img.src = img.dataset.src;
      img.classList.remove('lazy');
      imageObserver.unobserve(img);
    }
  });
});

// è§‚å¯Ÿæ‰€æœ‰æ‡’åŠ è½½å›¾ç‰‡
document.querySelectorAll('img[data-src]').forEach(img => {
  imageObserver.observe(img);
});
```

## âš¡ æ€§èƒ½ä¼˜åŒ–

### è™šæ‹Ÿæ»šåŠ¨

```javascript
// è™šæ‹Ÿæ»šåŠ¨å®ç°
class VirtualMasonry {
  constructor(container, items, itemHeight = 200) {
    this.container = container;
    this.items = items;
    this.itemHeight = itemHeight;
    this.visibleItems = [];
    this.scrollTop = 0;
    
    this.init();
  }
  
  init() {
    this.container.addEventListener('scroll', this.onScroll.bind(this));
    this.render();
  }
  
  onScroll() {
    this.scrollTop = this.container.scrollTop;
    this.render();
  }
  
  render() {
    const containerHeight = this.container.clientHeight;
    const startIndex = Math.floor(this.scrollTop / this.itemHeight);
    const endIndex = Math.min(
      startIndex + Math.ceil(containerHeight / this.itemHeight) + 1,
      this.items.length
    );
    
    // åªæ¸²æŸ“å¯è§åŒºåŸŸçš„é¡¹ç›®
    this.visibleItems = this.items.slice(startIndex, endIndex);
    this.updateDOM();
  }
}
```

### å›¾ç‰‡ä¼˜åŒ–

```javascript
// å“åº”å¼å›¾ç‰‡åŠ è½½
function getOptimalImageSize(containerWidth) {
  if (containerWidth <= 480) return 'small';
  if (containerWidth <= 768) return 'medium';
  return 'large';
}

// æ¸è¿›å¼å›¾ç‰‡åŠ è½½
function loadProgressiveImage(img) {
  // å…ˆåŠ è½½ä½è´¨é‡ç‰ˆæœ¬
  const lowQualitySrc = img.dataset.lowSrc;
  const highQualitySrc = img.dataset.highSrc;
  
  img.src = lowQualitySrc;
  
  // é¢„åŠ è½½é«˜è´¨é‡ç‰ˆæœ¬
  const highQualityImg = new Image();
  highQualityImg.onload = () => {
    img.src = highQualitySrc;
    img.classList.add('loaded');
  };
  highQualityImg.src = highQualitySrc;
}
```

## ğŸ¨ åŠ¨ç”»æ•ˆæœ

### è¿›å…¥åŠ¨ç”»

```css
.masonry-item {
  opacity: 0;
  transform: translateY(50px);
  transition: all 0.6s ease;
}

.masonry-item.loaded {
  opacity: 1;
  transform: translateY(0);
}

/* é”™å¼€åŠ¨ç”»æ—¶é—´ */
.masonry-item:nth-child(1) { transition-delay: 0.1s; }
.masonry-item:nth-child(2) { transition-delay: 0.2s; }
.masonry-item:nth-child(3) { transition-delay: 0.3s; }
```

### æ‚¬åœæ•ˆæœ

```css
.masonry-item {
  transition: transform 0.3s ease, box-shadow 0.3s ease;
}

.masonry-item:hover {
  transform: translateY(-10px);
  box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
}
```

## ğŸ”§ å®é™…åº”ç”¨å»ºè®®

### é€‰æ‹©åˆé€‚çš„æ–¹æ¡ˆ

1. **å†…å®¹ç±»å‹è€ƒè™‘**
   - å›¾ç‰‡ä¸ºä¸»ï¼šæ¨è Masonry.js + æ‡’åŠ è½½
   - æ–‡æœ¬å¡ç‰‡ï¼šå¯è€ƒè™‘ CSS Grid
   - æ··åˆå†…å®¹ï¼šMasonry.js æ›´çµæ´»

2. **æ€§èƒ½è¦æ±‚**
   - é«˜æ€§èƒ½è¦æ±‚ï¼šCSS Grid æˆ– Flexbox
   - åŠŸèƒ½ä¸°å¯Œï¼šMasonry.js
   - ç®€å•å±•ç¤ºï¼šCSS Columns

3. **æµè§ˆå™¨å…¼å®¹æ€§**
   - éœ€è¦å…¼å®¹æ—§æµè§ˆå™¨ï¼šMasonry.js + Flexbox é™çº§
   - ç°ä»£æµè§ˆå™¨ï¼šCSS Grid ä¼˜å…ˆ

### å¼€å‘æœ€ä½³å®è·µ

1. **é¢„åŠ è½½å…³é”®èµ„æº**
2. **å®ç°éª¨æ¶å±åŠ è½½**
3. **æ·»åŠ é”™è¯¯å¤„ç†æœºåˆ¶**
4. **è€ƒè™‘æ— éšœç¢è®¿é—®**
5. **æµ‹è¯•ä¸åŒè®¾å¤‡å’Œç½‘ç»œç¯å¢ƒ**

---

*ç€‘å¸ƒæµå¸ƒå±€æ˜¯ç°ä»£ç½‘é¡µè®¾è®¡çš„é‡è¦ç»„æˆéƒ¨åˆ†ï¼Œé€‰æ‹©åˆé€‚çš„å®ç°æ–¹æ¡ˆå¹¶æ³¨é‡æ€§èƒ½ä¼˜åŒ–ï¼Œå¯ä»¥åˆ›é€ å‡ºä¼˜ç§€çš„ç”¨æˆ·ä½“éªŒã€‚* ğŸ“±
