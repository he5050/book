---
title: MarkdownAi
date: 2025-08-05 15:12:00
permalink: /notes/markdown-ai-demo
categories:
  - 笔记
tags:
  - React
  - TypeScript
  - Markdown
  - ECharts
  - AI对话
---

# MarkdownAI 组件

基于 React 的 AI 对话 Markdown 渲染组件，**完全基于 base.tsx 的实现**，并扩展了 ECharts 图表和引用标记支持。

## 功能特性

- ✅ **完全基于 base.tsx**: 保持与原有代码块组件的一致性
- ✅ **代码高亮和复制**: 使用 Popover 显示复制成功提示
- ✅ **主题切换**: 支持明暗主题切换
- ✅ **ECharts 图表支持**: 自动识别并渲染多种图表类型
- ✅ **引用标记处理**: 支持 `[[数字,'描述']]` 格式的可点击引用
- ✅ **表格渲染优化**: 美化的表格样式
- ✅ **HTML 标签支持**: 支持在 Markdown 中嵌入 HTML
- ✅ **空白行处理优化**: 解决 HTML 渲染间距过大问题
- ✅ **链接处理**: 自动在新窗口打开外部链接
- ✅ **TypeScript 支持**: 完整的类型安全

## 技术栈

- **react-markdown** - Markdown 渲染核心
- **react-syntax-highlighter** - 代码语法高亮
- **ECharts** - 数据可视化图表
- **Ant Design** - UI 组件库
- **github-markdown-css** - GitHub 风格样式

## 核心实现

### 1. 代码块组件

```typescript
// 完全基于 base.tsx 的实现
function CodeBlock({ code, language = '' }: { code: string; language?: string }) {
	const [isDarkTheme, setIsDarkTheme] = useState(false);
	const [copied, setCopied] = useState(false);

	const handleCopy = () => {
		setCopied(true);
		setTimeout(() => setCopied(false), 2000);
	};

	return (
		<div style={{ position: 'relative', margin: '16px 0' }}>
			{/* 与 base.tsx 完全一致的按钮样式 */}
			<div
				style={{
					position: 'absolute',
					right: 8,
					top: 8,
					zIndex: 1,
					backgroundColor: 'rgba(255, 255, 255, 0.2)', // 与 base.tsx 一致
					borderRadius: 4,
					padding: 4
				}}
			>
				<Space>
					<Button
						type="text"
						size="small"
						icon={isDarkTheme ? <BulbFilled /> : <BulbOutlined />}
						onClick={() => setIsDarkTheme(!isDarkTheme)}
					/>
					{/* 使用 Popover 显示复制提示，与 base.tsx 一致 */}
					<Popover open={copied} content="已复制！" trigger={[]}>
						<CopyToClipboard text={code} onCopy={handleCopy}>
							<Button type="text" size="small" icon={<CopyOutlined />} />
						</CopyToClipboard>
					</Popover>
				</Space>
			</div>

			<SyntaxHighlighter
				language={language.toLowerCase()}
				style={isDarkTheme ? materialOceanic : materialLight}
				customStyle={{
					padding: '40px 20px 20px',
					borderRadius: 8,
					fontSize: 14,
					overflowX: 'auto'
				}}
				PreTag="div"
			>
				{code.trim()}
			</SyntaxHighlighter>
		</div>
	);
}
```

### 2. ECharts 图表支持

```typescript
// 自动识别图表类型的 ECharts 容器
const EChartsContainer: React.FC<{ id: string; style?: React.CSSProperties }> = ({ id, style }) => {
	const chartRef = useRef<echarts.ECharts | null>(null);

	useEffect(() => {
		const chartContainer = document.getElementById(id);
		if (chartContainer && !chartRef.current) {
			chartRef.current = echarts.init(chartContainer);

			// 根据容器 ID 自动选择图表类型
			let option: echarts.EChartsOption = {};

			if (id.includes('line') || id.includes('1')) {
				// 折线图配置
				option = {
					/* 折线图配置 */
				};
			} else if (id.includes('bar') || id.includes('2')) {
				// 柱状图配置
				option = {
					/* 柱状图配置 */
				};
			} else if (id.includes('pie') || id.includes('3')) {
				// 饼图配置
				option = {
					/* 饼图配置 */
				};
			}

			chartRef.current.setOption(option);
		}
	}, [id]);

	return <div id={id} style={{ width: '100%', height: '400px', ...style }} />;
};
```

### 3. 引用标记处理

```typescript
// 处理 [[数字,'描述']] 格式的引用标记
const replaceReferences = (str: string): string => {
	const regex = /\[\[(\d+),'(.*?)'\]\]/g;

	return str.replace(regex, (match, num, id) => {
		return `<sup className="text-blue-600 cursor-pointer" data-supid="${id}">[${num}]</sup>`;
	});
};

// 点击引用标记的处理
const handleSupClick = (event: React.MouseEvent<HTMLElement>) => {
	const target = event.target as HTMLElement;
	const supid = target.dataset.supid;
	if (supid) {
		message.info(`点击了引用: ${supid}`);
	}
};
```

## 使用方法

### 基本使用

<demo react="react/MarkdownEcharts/playground.tsx" 
:reactFiles="['react/MarkdownEcharts/playground.tsx','react/MarkdownEcharts/MarkdownAI.tsx']" 
/>

### ECharts 图表类型

| 容器 ID 格式                          | 图表类型 | 示例                       |
| ------------------------------------- | -------- | -------------------------- |
| `echarts-container-line-*` 或包含 `1` | 折线图   | `echarts-container-line-1` |
| `echarts-container-bar-*` 或包含 `2`  | 柱状图   | `echarts-container-bar-2`  |
| `echarts-container-pie-*` 或包含 `3`  | 饼图     | `echarts-container-pie-3`  |

### 引用标记格式

```markdown
这是一段包含引用的文本 [[1,'重要说明']]。
点击数字 1 会显示"重要说明"的提示信息。
```

## 样式定制

组件使用 `github-markdown-css` 作为基础样式，支持自定义：

```css
.custom-markdown {
	/* 自定义样式 */
}

.custom-markdown .markdown-body {
	/* 覆盖默认样式 */
	font-size: 16px;
	line-height: 1.8;
}
```

## 空白行处理

组件内置了空白行处理插件，解决 HTML 渲染时间距过大的问题：

```typescript
const removeExtraWhitespace = () => {
	return (tree: any) => {
		const removeWhitespace = (node: any) => {
			// 保持 pre 标签内的空白
			if (node.tagName === 'pre') return;

			if (node.type === 'text') {
				// 将多个空白字符替换为单个空格
				node.value = node.value.replace(/\s+/g, ' ');
			}

			if (node.children) {
				node.children = node.children.filter((child: any) => {
					if (child.type === 'text') {
						return child.value.trim() !== '';
					}
					removeWhitespace(child);
					return true;
				});
			}
		};

		removeWhitespace(tree);
		return tree;
	};
};
```

## 项目结构优化

### 文件整合

为了简化项目结构，所有演示功能都整合到了 `playground.tsx` 中：

```
MarkdownEcharts/
├── MarkdownAI.tsx      # 主组件（纯外部数据驱动）
├── base.tsx            # 基础代码块组件（参考实现）
├── echarts.tsx         # ECharts 集成示例
├── playground.tsx      # 综合演示平台（包含所有演示功能）
└── README.md           # 详细文档
```

### playground.tsx 功能

- **完整演示**: 展示所有功能特性的静态演示
- **交互测试**: 实时编辑和预览 Markdown 内容
- **外部数据**: 外部数据驱动的图表示例
- **无数据状态**: 展示无数据时的占位符效果
- **调试测试**: 图表渲染问题的调试工具
- **使用说明**: 详细的 API 文档和使用指南

### 重要变更

1. **纯外部数据驱动**: 移除了所有内置模拟数据
2. **统一演示平台**: 所有演示功能整合到一个文件
3. **更清晰的结构**: 减少了文件数量，提高了可维护性

---

_现在只需要运行 `playground.tsx` 就能体验 MarkdownAI 组件的所有功能！_
