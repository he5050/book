---
title: Docker入门到实战
date: 2025-09-08 16:00:00
permalink: /notes/docker-guide
description: Docker 从入门到实战的完整指南，涵盖基础概念、常用命令和实际应用
categories:
  - 笔记
  - Docker
tags:
  - Docker
  - 容器化
  - DevOps
---

# Docker 入门到实战完整指南

Docker 是一个开源的容器化平台，它允许开发者将应用程序及其依赖项打包到一个轻量级、可移植的容器中。这些容器可以在任何支持 Docker 的环境中运行，无论是本地开发环境、测试环境还是生产环境。

## 1. Docker 核心概念

理解 Docker 的核心概念是使用 Docker 的第一步。我们可以用烘焙蛋糕来比喻 Docker 的工作原理：

- **Dockerfile**：蛋糕的配方，详细列出了需要的材料和制作步骤
- **镜像（Image）**：按照配方制作出的半成品蛋糕，可以被任何人复制
- **容器（Container）**：将半成品蛋糕烘焙后得到的可食用蛋糕，每个容器都是独立的

### 1.1 镜像与容器的关系

镜像是 Docker 容器的基础，它包含了运行应用程序所需的所有内容，包括代码、运行时环境、系统工具和系统库。容器是镜像的运行实例，可以被启动、停止、删除等。

### 1.2 Docker 层次结构

Docker 使用分层文件系统，每一层都代表镜像的某些部分。这种设计使得镜像可以共享基础层，从而节省存储空间并提高传输效率。

## 2. Docker 安装与配置

### 2.1 不同操作系统的安装方法

#### Windows 安装方法

1. 确保 Windows 10/11 版本并启用虚拟化功能
2. 在 Windows 上安装 Hyper-V
3. 从 Docker 官网下载 Docker Desktop 并安装
4. 安装完成后需要重启系统完成安装
5. 首次启动需要同意协议，并可能需要更新 WSL

#### macOS 安装方法

1. 从 Docker 官网下载 Docker Desktop 的 macOS 版本
2. 直接安装并运行 Docker Desktop

#### Ubuntu 安装方法

```bash
# 更新软件包列表
sudo apt-get update

# 安装必要的软件包
sudo apt-get install apt-transport-https ca-certificates curl software-properties-common

# 添加 Docker 的官方 GPG 密钥
curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo apt-key add -

# 添加 Docker 的 APT 仓库
sudo add-apt-repository "deb [arch=amd64] https://download.docker.com/linux/ubuntu $(lsb_release -cs) stable"

# 更新 APT 包列表并安装 Docker
sudo apt-get update
sudo apt-get install docker-ce

# 验证安装
sudo docker run hello-world
```

### 2.2 配置用户权限

为避免每次使用 Docker 命令都需要 sudo，可以将当前用户添加到 docker 组：

```bash
sudo usermod -aG docker ${USER}
```

然后重新登录以使更改生效。

## 3. Docker 基本命令详解

### 3.1 镜像管理命令

#### docker pull

从 Docker Hub 或其他注册表拉取镜像：

```bash
# 拉取最新版本的 nginx 镜像
docker pull nginx:latest

# 拉取特定版本的镜像
docker pull mysql:8.0
```

#### docker images

列出本地存储的所有镜像：

```bash
# 列出所有镜像
docker images

# 列出特定镜像
docker images nginx
```

#### docker rmi

删除本地镜像：

```bash
# 删除指定镜像
docker rmi nginx:latest

# 强制删除正在使用的镜像
docker rmi -f nginx:latest
```

#### docker build

根据 Dockerfile 构建镜像：

```bash
# 在当前目录构建镜像
docker build -t my-app:latest .

# 指定 Dockerfile 路径构建镜像
docker build -t my-app:latest -f /path/to/Dockerfile .
```

#### docker save/load

导出和导入镜像（适用于离线环境）：

```bash
# 导出镜像到文件
docker save -o nginx.tar nginx:latest

# 从文件导入镜像
docker load -i nginx.tar
```

### 3.2 容器管理命令

#### docker run

创建并启动一个新的容器：

```bash
# 基本用法
docker run nginx:latest

# 后台运行容器
docker run -d --name my-nginx nginx:latest

# 端口映射
docker run -d --name my-nginx -p 8080:80 nginx:latest

# 环境变量设置
docker run -d --name my-mysql -e MYSQL_ROOT_PASSWORD=root mysql:8.0

# 目录挂载
docker run -d --name my-nginx -v /host/path:/container/path nginx:latest

# 容器运行结束后自动销毁
docker run --rm nginx:latest
```

#### docker ps

列出容器：

```bash
# 列出正在运行的容器
docker ps

# 列出所有容器（包括已停止的）
docker ps -a

# 只显示容器 ID
docker ps -q
```

#### docker stop/start/restart

控制容器的运行状态：

```bash
# 停止容器
docker stop my-nginx

# 启动容器
docker start my-nginx

# 重启容器
docker restart my-nginx
```

#### docker rm

删除容器：

```bash
# 删除已停止的容器
docker rm my-nginx

# 强制删除正在运行的容器
docker rm -f my-nginx

# 批量删除已停止的容器
docker container prune
```

#### docker exec

在运行中的容器内执行命令：

```bash
# 进入容器的交互式 shell
docker exec -it my-nginx /bin/bash

# 在容器中执行单个命令
docker exec my-nginx ls /etc
```

#### docker logs

查看容器日志：

```bash
# 查看容器日志
docker logs my-nginx

# 实时查看日志
docker logs -f my-nginx

# 查看最近的 100 行日志
docker logs --tail 100 my-nginx
```

#### docker commit

将容器打包成镜像：

```bash
# 将容器保存为新镜像
docker commit container-id new-image-name:tag
```

#### docker top

显示容器正在运行的进程：

```bash
# 查看容器内运行的进程
docker top container-name
```

### 3.3 网络管理命令

#### docker network

管理 Docker 网络：

```bash
# 创建网络
docker network create my-network

# 列出网络
docker network ls

# 删除网络
docker network rm my-network

# 查看网络详情
docker network inspect my-network

# 创建自定义网络
docker network create --driver bridge my-custom-network
```

在创建容器时指定网络：

```bash
# 创建容器并连接到指定网络
docker run -d --name my-nginx --network my-network nginx:latest
```

### 3.4 存储管理命令

#### docker volume

管理数据卷：

```bash
# 创建数据卷
docker volume create my-volume

# 列出数据卷
docker volume ls

# 删除数据卷
docker volume rm my-volume

# 查看数据卷详情
docker volume inspect my-volume

# 清理未使用的数据卷
docker volume prune
```

在创建容器时使用数据卷：

```bash
# 使用命名数据卷
docker run -d --name my-mysql -v mysql-data:/var/lib/mysql -e MYSQL_ROOT_PASSWORD=root mysql:8.0

# 使用绑定挂载
docker run -d --name my-nginx -v /host/data:/container/data nginx:latest

# 使用 tmpfs 挂载
docker run -d --name my-app --tmpfs /tmp nginx:latest
```

## 4. Dockerfile 编写指南

Dockerfile 是一个文本文件，包含了一系列指令，用于自动化构建 Docker 镜像。

### 4.1 Dockerfile 指令详解

#### FROM

指定基础镜像：

```dockerfile
# 指定基础镜像
FROM ubuntu:20.04

# 使用 Alpine Linux 以减小镜像大小
FROM alpine:latest
```

#### WORKDIR

设置工作目录：

```dockerfile
# 设置工作目录
WORKDIR /app

# 后续的指令都会在这个目录下执行
```

#### COPY 和 ADD

复制文件到容器：

```dockerfile
# COPY 更推荐使用，仅复制文件
COPY . /app

# ADD 功能更强大，可以解压压缩包等
ADD myapp.tar.gz /app
```

#### RUN

执行命令：

```dockerfile
# 安装依赖
RUN apt-get update && apt-get install -y python3

# 合并多个 RUN 指令以减少镜像层数
RUN apt-get update && \
    apt-get install -y python3 python3-pip && \
    rm -rf /var/lib/apt/lists/*
```

#### ENV

设置环境变量：

```dockerfile
# 设置环境变量
ENV NODE_ENV=production
ENV PORT=3000
```

#### ARG

定义构建参数：

```dockerfile
# 定义构建参数
ARG NODE_VERSION=16

# 使用构建参数
FROM node:${NODE_VERSION}
```

#### EXPOSE

声明端口：

```dockerfile
# 声明端口
EXPOSE 3000
```

#### VOLUME

创建挂载点：

```dockerfile
# 创建挂载点
VOLUME ["/data"]
```

#### CMD 和 ENTRYPOINT

指定容器启动时执行的命令：

```dockerfile
# CMD 提供默认执行命令
CMD ["python3", "app.py"]

# ENTRYPOINT 指定容器入口点
ENTRYPOINT ["python3", "app.py"]

# CMD 和 ENTRYPOINT 结合使用
ENTRYPOINT ["python3"]
CMD ["app.py"]
```

#### HEALTHCHECK

配置运行时健康检查：

```dockerfile
# 配置健康检查
HEALTHCHECK --interval=30s --timeout=3s --start-period=5s --retries=3 \
  CMD curl -f http://localhost:3000/ || exit 1
```

### 4.2 构建优化技巧

1. **合理安排指令顺序**：将变化频率低的指令放在前面，利用 Docker 的缓存机制
2. **合并 RUN 指令**：减少镜像层数
3. **使用 .dockerignore**：排除不必要的文件
4. **选择合适的基础镜像**：使用 Alpine 版本减小镜像大小
5. **以非 root 用户运行**：提高安全性

```dockerfile
# 示例：优化后的 Dockerfile
FROM node:16-alpine

# 创建非 root 用户
RUN addgroup -g 1001 -S nodejs && \
    adduser -S nextjs -u 1001

# 设置工作目录
WORKDIR /app

# 复制依赖文件
COPY package*.json ./

# 安装依赖
RUN npm ci --only=production && npm cache clean --force

# 复制应用代码
COPY . .

# 更改文件所有者
RUN chown -R nextjs:nodejs /app

# 切换到非 root 用户
USER nextjs

# 暴露端口
EXPOSE 3000

# 健康检查
HEALTHCHECK --interval=30s --timeout=3s --start-period=5s --retries=3 \
  CMD curl -f http://localhost:3000/ || exit 1

# 启动命令
CMD ["node", "server.js"]
```

## 5. Docker Compose 使用指南

Docker Compose 是用于定义和运行多容器 Docker 应用程序的工具。

### 5.1 安装 Docker Compose

```bash
# Docker Desktop 已内置 Docker Compose
# Linux 系统需要单独安装
sudo curl -L "https://github.com/docker/compose/releases/download/v2.23.3/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose

sudo chmod +x /usr/local/bin/docker-compose
```

### 5.2 docker-compose.yml 文件结构

```yaml
version: '3.8'

services:
  web:
    build: .
    ports:
      - '3000:3000'
    depends_on:
      - db
    environment:
      DB_HOST: db
      DB_USER: myuser
      DB_PASSWORD: mypassword
      DB_NAME: myapp
    volumes:
      - ./logs:/app/logs

  db:
    image: mysql:8.0
    environment:
      MYSQL_ROOT_PASSWORD: rootpassword
      MYSQL_DATABASE: myapp
      MYSQL_USER: myuser
      MYSQL_PASSWORD: mypassword
    volumes:
      - mysql-data:/var/lib/mysql
      - ./mysql/init:/docker-entrypoint-initdb.d
    ports:
      - '3306:3306'

volumes:
  mysql-data:
```

### 5.3 常用 Docker Compose 命令

```bash
# 启动所有服务
docker-compose up

# 后台启动所有服务
docker-compose up -d

# 停止所有服务
docker-compose down

# 查看服务状态
docker-compose ps

# 查看日志
docker-compose logs

# 查看特定服务日志
docker-compose logs web

# 重新构建服务
docker-compose build

# 重新构建并启动服务
docker-compose up --build

# 停止特定服务
docker-compose stop web

# 启动特定服务
docker-compose start web

# 重启特定服务
docker-compose restart web

# 在服务中执行命令
docker-compose exec web /bin/bash

# 扩展服务（运行多个实例）
docker-compose up --scale web=3
```

### 5.4 Docker Compose 网络和存储

```yaml
version: '3.8'

services:
  web:
    build: .
    networks:
      - frontend
      - backend
    volumes:
      - web-data:/app/data

  api:
    build: ./api
    networks:
      - backend
    volumes:
      - api-data:/app/data

  db:
    image: postgres:13
    networks:
      - backend
    volumes:
      - db-data:/var/lib/postgresql/data

networks:
  frontend:
    driver: bridge
  backend:
    driver: bridge

volumes:
  web-data:
  api-data:
  db-data:
```

## 6. 实战应用：容器化应用部署

### 6.1 部署 Web 应用

以部署一个简单的 Node.js 应用为例：

```dockerfile
# Dockerfile
FROM node:16-alpine

WORKDIR /app

COPY package*.json ./
RUN npm install

COPY . .

EXPOSE 3000

CMD ["node", "server.js"]
```

构建和运行：

```bash
# 构建镜像
docker build -t my-node-app .

# 运行容器
docker run -d --name my-app -p 3000:3000 my-node-app
```

### 6.2 数据库容器化

以 MySQL 为例：

```bash
# 运行 MySQL 容器
docker run -d \
  --name mysql-db \
  -e MYSQL_ROOT_PASSWORD=my-secret-pw \
  -e MYSQL_DATABASE=myapp \
  -e MYSQL_USER=myuser \
  -e MYSQL_PASSWORD=mypassword \
  -v mysql-data:/var/lib/mysql \
  -p 3306:3306 \
  mysql:8.0
```

### 6.3 使用 Docker Compose 管理多容器应用

创建 `docker-compose.yml` 文件：

```yaml
version: '3.8'

services:
  web:
    build: .
    ports:
      - '3000:3000'
    depends_on:
      - db
    environment:
      DB_HOST: db
      DB_USER: myuser
      DB_PASSWORD: mypassword
      DB_NAME: myapp

  db:
    image: mysql:8.0
    environment:
      MYSQL_ROOT_PASSWORD: rootpassword
      MYSQL_DATABASE: myapp
      MYSQL_USER: myuser
      MYSQL_PASSWORD: mypassword
    volumes:
      - mysql-data:/var/lib/mysql
    ports:
      - '3306:3306'

volumes:
  mysql-data:
```

使用 Docker Compose：

```bash
# 启动所有服务
docker-compose up -d

# 停止所有服务
docker-compose down

# 查看服务状态
docker-compose ps

# 查看日志
docker-compose logs
```

## 7. Docker 网络和存储进阶

### 7.1 网络模式

Docker 提供了多种网络模式：

1. **Bridge 模式**：默认模式，容器通过虚拟网桥连接
2. **Host 模式**：容器直接使用宿主机网络
3. **None 模式**：容器没有网络接口
4. **Container 模式**：容器与其他容器共享网络命名空间

```bash
# 使用 host 网络模式
docker run --network host nginx:latest

# 使用 none 网络模式
docker run --network none nginx:latest

# 使用 container 网络模式
docker run --network container:other-container nginx:latest
```

### 7.2 数据持久化策略

1. **数据卷（Volume）**：由 Docker 管理，推荐用于生产环境
2. **绑定挂载（Bind Mount）**：直接挂载宿主机目录
3. **临时文件系统（tmpfs）**：存储在内存中

```bash
# 使用数据卷
docker run -v my-volume:/data nginx:latest

# 使用绑定挂载
docker run -v /host/path:/container/path nginx:latest

# 使用 tmpfs
docker run --tmpfs /tmp nginx:latest
```

### 7.3 自定义网络配置

```bash
# 创建自定义 bridge 网络
docker network create --driver bridge --subnet=172.20.0.0/16 --ip-range=172.20.240.0/20 my-custom-network

# 在自定义网络中运行容器
docker run -d --name web --network my-custom-network nginx:latest
```

## 8. Docker 安全最佳实践

### 8.1 镜像安全

1. 使用官方或可信的镜像
2. 定期更新基础镜像
3. 扫描镜像漏洞
4. 使用特定版本而非 latest 标签

```dockerfile
# 使用特定版本而非 latest
FROM node:16.14-alpine

# 以非 root 用户运行
USER node
```

### 8.2 容器安全

1. 限制容器资源使用
2. 禁用不必要的权限
3. 使用只读文件系统
4. 不在容器中存储敏感信息

```bash
# 限制内存使用
docker run --memory=512m nginx:latest

# 以只读模式运行
docker run --read-only nginx:latest

# 禁用特权模式
docker run --cap-drop=ALL nginx:latest

# 限制 CPU 使用
docker run --cpus="1.5" nginx:latest
```

### 8.3 网络安全

1. 使用用户自定义网络而非默认 bridge 网络
2. 限制容器间的网络访问
3. 使用网络安全策略

```bash
# 创建用户自定义网络
docker network create my-secure-network

# 在自定义网络中运行容器
docker run --network my-secure-network nginx:latest
```

## 9. 常见问题与解决方案

### 9.1 Docker 服务无法连接

```bash
# 检查 Docker 服务状态
sudo systemctl status docker

# 启动 Docker 服务
sudo systemctl start docker

# 重启 Docker 服务
sudo systemctl restart docker
```

### 9.2 容器无法访问外部网络

1. 检查防火墙设置
2. 验证 DNS 配置
3. 检查网络代理设置
4. 确认容器网络配置

### 9.3 磁盘空间不足

```bash
# 清理未使用的镜像
docker image prune

# 清理未使用的容器
docker container prune

# 清理未使用的数据卷
docker volume prune

# 清理未使用的网络
docker network prune

# 清理所有未使用的资源
docker system prune

# 查看磁盘使用情况
docker system df
```

### 9.4 容器日志过大

```bash
# 限制容器日志大小
docker run --log-opt max-size=10m --log-opt max-file=3 nginx:latest

# 在 docker-compose.yml 中配置日志
# logging:
#   driver: "json-file"
#   options:
#     max-size: "10m"
#     max-file: "3"
```

## 10. 总结

Docker 作为现代软件开发和部署的重要工具，提供了以下优势：

1. **环境一致性**：一次构建，处处运行
2. **资源利用率高**：相比虚拟机更轻量级
3. **快速部署**：秒级启动容器
4. **易于扩展**：支持微服务架构
5. **版本控制**：镜像可以版本化管理
